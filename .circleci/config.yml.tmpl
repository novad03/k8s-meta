# -*- mode: yaml -*-

version: 2
jobs:
{{- range .GoVersions }}
  test-{{.}}:
    working_directory: /go/src/go.universe.tf/metallb
    docker:
      - image: circleci/golang:{{.}}
    steps:
      - checkout
      - run: make ci-prepare
      - run: make ci-build
      - run: make ci-test
      - run: make ci-lint
{{- end }}
{{- range $bin := $.Binary }}
{{- range $arch := $.Arch }}
  deploy-{{$bin}}-{{$arch}}:
    working_directory: /go/src/go/universe.tf/metallb
    docker:
      - image: circleci/golang:1.9
    steps:
      - checkout
      - setup_remote_docker
      - run: docker login -u $DOCKER_USER -p $DOCKER_PASSWORD
      - run: make ci-prepare
      - run: make gen-image-targets TAG=$CIRCLE_BRANCH REGISTRY=danderson
      - run: make -f Makefile.image-targets {{$bin}}/{{$arch}}    
{{- end }}
  deploy-{{$bin}}:
    working_directory: /go/src/go/universe.tf/metallb
    docker:
      - image: circleci/golang:1.9
    steps:
      - checkout
      - setup_remote_docker
      - run: docker login -u $DOCKER_USER -p $DOCKER_PASSWORD
      - run: make ci-prepare
      - run: make gen-image-targets TAG=$CIRCLE_BRANCH REGISTRY=danderson
      - run: make -f Makefile.image-targets {{$bin}}-manifest-only
{{- end }}
workflows:
  version: 2
  test-and-deploy:
    jobs:
{{- range .GoVersions }}
      - test-{{.}}
{{- end }}
{{- range $bin := $.Binary }}
{{- range $arch := $.Arch }}
      - deploy-{{$bin}}-{{$arch}}:
          requires:
            - test-1.8
            - test-1.9
{{- end }}
      - deploy-{{$bin}}:
          requires:
{{- range $arch := $.Arch }}
            - deploy-{{$bin}}-{{$arch}}
{{- end }}
{{- end }}
